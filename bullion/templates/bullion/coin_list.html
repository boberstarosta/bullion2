{% extends 'bullion/base.html' %}

{% block title %}Monety{% endblock %}

{% block content %}

<div class="container">
    <div class="page-header">
        <h1 class="text-center">Monety</h1>
    </div>
    {% if all_coins %}
        <table id="coinTable" class="table table-striped table-condensed" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th></th>
                    <th class="text-center">Państwo</th>
                    <th class="text-center">Nominał</th>
                    <th class="text-center">Lata bicia</th>
                    <th class="text-center">Opis</th>
                    <th class="text-center">Metal</th>
                    <th class="text-center">Próba</th>
                    <th class="text-center">Waga</th>
                    <th class="text-right">Wartość</th>
                </tr>
            </thead>
            <tbody>
                {% for coin in all_coins %}
                    <tr>
                        <td>
                            <a href="{% url 'coin_detail' coin.pk %}" title="Szczegóły...">
                                <span class="glyphicon glyphicon-info-sign"></span>
                            </a>
                        </td>
                        <td>{{ coin.country }}</td>
                        <td>{{ coin.face_value }}</td>
                        <td>{{ coin.mint_years }}</td>
                        <td>{{ coin.comments }}</td>
                        <td>{{ coin.metal.short_name }}</td>
                        <td>{{ coin.fineness }}</td>
                        <td>{{ coin.weight }}</td>
                        <td id="coin_{{ coin.pk }}" class="text-right">{{ coin.price|floatformat:2 }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-center">Nie ma żadnych monet do pokazania.</p>
    {% endif %}
</div>

{% endblock %}

{% block javascript %}

<script>
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        }
    });

    function updatePricesOnPage(data) {
    }

    function sendUpdatePricesRequest() {
        data = {};
        $.ajax({
            url: '{% url 'update_coin_prices' %}',
            type: 'POST',
            data: data,
            dataType: 'json',
            success: function (data) {
                updatePricesOnPage(data)
            },
            error: function(xhr, textStatus, error) {
                console.log('AJAX error: ' + xhr.status + ' ' + error)
            }
        })
    }

    function sendGetPricesRequest() {
        data = {};
        $.ajax({
            url: '{% url 'get_coin_prices' %}',
            type: 'GET',
            data: data,
            dataType: 'json',
            success: function (data) {
                updatePricesOnPage(data)
            },
            error: function(xhr, textStatus, error) {
                console.log('AJAX error: ' + xhr.status + ' ' + error)
            }
        })
    }

    $(document).ready( function() {
        sendGetPricesRequest();
        sendUpdatePricesRequest();
    });

    setInterval(function () {
        sendUpdatePricesRequest();
    }, 10000);

</script>

{% endblock %}
